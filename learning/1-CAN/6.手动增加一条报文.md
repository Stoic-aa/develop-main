# 手动增加一条报文

## 目录

1. [目的](##目的)
2. [原始SIP-demo](##原始sip-demo)
3. [打开SIP包](##打开SIP软件包)
4. [代码生成](##代码生成)
5. [新增报文清单](##新增报文清单)
6. [模块配置](##模块配置)

## 目的
在DBC文件相关的讲解中,已经介绍了了如何分析DBC文件,制作DBC文件,并通过DavinciCFG工具通过输入的 DBC 文件生成了CAN相关的STACK协议栈的相关模块,并对这些模块进行了熟悉和了解,例如其中的CAN-STACK的COM模块,PDUR模块,CANIF模块,CAN模块等等,并结合信号的传输流程进行了梳理,但是不够深入,只是从直观的角度对相关的链路进行熟悉,**并且模块还是有报错的,而且缺少例如RTE层和OS以及MCAL相关的内容,导致我们是不能直接生成代码,可运行的环境的**,下面将通过手动增加一条报文的形式,进行一个实战的演练和熟悉

## IAR-S32K144-原始SIP demo

1. 修改代码是在原始层demo上进行的改动, 原始demo 是 Vector 公司针对 S32K144 给出的 一个 IAR 的SIP软件包的 demo
2. 配置之前一定要对 SIP 进行 git 版本管理, 这样进行配置改动时, 能快捷的找到对应的改动进行回溯

## 打开 SIP 软件包
1. 用 DaVinci CFG 打开工程.dba文件 ,以看到 demo 中的配置模块是相对完整的,而且没有错误XX 的
![alt text](./picture/open-sip.png)


## 代码生成
1. On-demand 工程检查
![alt text](./picture/project_check.png)
![alt text](./picture/project_check_1.png)
![alt text](./picture/project_check_2.png)

2. Generate code 代码生成,正常的 project 检查没有问题的话,就可与进行代码的生成了
![alt text](./picture/generate_code.png)
![alt text](./picture/generate_code_1.png)

3. 代码生成成功后, origin-demo 基本没啥问题, 可以进行目标的完成了

## 报文配置清单
1. 要手动田间一条CAN报文,需要相关的配置项进行配置,需要进行配置的配置模块是和CAN-STACK相关的模块,如下所示,这里非完全展示
    | 项目      | 值 |
    |-----------|-----|
    | Signal    | RearLeft_Window |
    | Message   | Msg_MyECU2_Transmit |
    | ID        | 0x600 |
    | CAN类型   | STANDARD_CAN |

    | 配置层  | 映射关系 |
    |--------|----------|
    | COM->PDUR   | MyECU2_Ipdu_com2pdur |
    | PDUR->CANIF | MyECU2_Ipdu_pdur2canif |

    | 配置项  | 名称 |
    |--------|------|
    | ComIpdu | MyECU2_Com_CAN_Network |
    | PduSignalProcess | - |
    | ComIpduType | - |
    | ComIpduGroupRef | - |
    | 创建 | ComSignal |
    .....

## 模块配置

1. 首先在 EcuC 中添加两条 pdu, 并编辑对应的信息,在EcuC中添加两个目的是有CAN-STACK可以看出有两条 I-PDU 的线路:

    | 配置层(ECUC)  | 映射关系  |
    |---------|----------|
    | **COM->PDUR**   | MyECU2_Ipdu_com2pdur |
    | **PDUR->CANIF** | MyECU2_Ipdu_pdur2canif |

    ![alt text](./picture/EcuC_1.png)
    ![alt text](./picture/EcuC_2.png)
    ![alt text](./picture/EcuC_3.png)

2. 配置COM模块,先添加signal的相关内容, 然后添加IPdu的内容

    | 配置层(COM)    | 映射关系  |
    |----------------|----------|
    | signal-name    | RearLeft_Window |
    | signal-message | Msg_MyECU2_Transmit |
    | signal-ID      | 0x600 |
    | signal-type    | STANDARD_CAN |

    ![alt text](./picture/com_add_signal.png)

    | 配置项             | 映射关系    |
    |-------------------|-------------|
    |ComIpdus-name      |MyECU2_Com_CAN_Network|
    |ComIpdus-direction | send |
    |ComIpdus-process   |IMMEDIATE|
    |ComIpdus-ref       | 之前在ECUC中创建的全局 I-PDU(MyECU2_Ipdu_com2pdur)|
    |ComIpdus-transfer Property|- PENDING: writing to the signal does not cause direct transmission.|

    ![alt text](./picture/com_add_ComIPdus_1.png)

    ![alt text](./picture/com_add_ComIPdus_2.png)

    ![alt text](./picture/com_add_ComIPdus_3.png)

    ![alt text](./picture/com_add_ComIPdus_4.png)

    这里绑定完我们的信号,总结也就是首先在Com模块中对我们的ComSignals中信号signal的添加,并配置signal的相关属性,配置完毕后就是配置 ComIPdus的相关属性,创建IPdu配置,并执向在Ecuc中创建的I-PDU,同时把引用指向我们的刚才创建的 signal,这样就基本完成了Com模块的配置,从我们的配置中也可以看出来,我们的Com模块主要的功能就是接收和封装signal信号成I-Pdu的模块,并发送到我们的 IPdu-RT模块

3. PDuR 模块配置, 主要是是配置 PDuR 中的 PDuRRouttingPaths的配置, 这个模块的主要作用就是对IPdu的数据进行路由转发:
**PduR/PduRRoutingTables/PduRRoutingTable/PduRRoutingPaths**
创建PduRRouttingPath并填好dest和src的相关Pdus

    |配置项                   | 映射关系 |
    |------------------------|----------|
    | PduR->PduRRoutingPaths | 创建 PduRRouttingPath|
    | PduRRouingPaths-name   | MyECU2_Pdur_CAN_Network|
    | PduRDestPdus      |-|
    | PduRSrcPdus       |-|

    ![alt text](./picture/PduR_add_PduRRouttingPath_name.png)

    ![alt text](./picture/PduR_add_PduRRouttingPath.png)

    **PduRDestPdus**:
    
    ![alt text](./picture/PduR_add_PduRDestPdus.png)

    **PduRSrcPdus**:

    ![alt text](./picture/PduR_add_PduRSrcPdus_1.png)

    这里还有报错是因为下属的 CanIf的模块还没有进行配置
    ![alt text](./picture/PduR_add_PduRSrcPdus.png)

4. CanIf 模块配置, 这部分的配置属于接口层的配置,主要是为了对PDuR路由模块的 I-PDU 数据进行进一步的打包为L-PDU数据,(其实这中间还有一个 CanTP的模块, 这个主要是也是接 PDuR的I-PDU数据进行转发到 CanIf模块,而 PDuR 模块也可以直接把I-PDU数据路由到 CanIf 模块)
**CanIf/CanIfInitCfg/CanIfTxPduCfgs/CanIfTxPduCfg**

    |配置项                   | 映射关系 |
    |------------------------|----------|
    | CanifTxPduCfgs | 创建 PduRRouttingPath|
    | PduRRouingPaths-name   | MyECU2_Canif_CAN_Network|
    | type      | STANDARD_CAN|
    | id        | 0X600|

    ![alt text](./picture/PduR_add_CanIfTxPduCfg.png)

    **接着创建 CanIfBufferCfgs :**

    |配置项   | 映射关系 |
    |---------| ---- |
    |name     |Buffer_Can_Network_Tx_Mailbox|

    ![alt text](./picture/PduR_add_CanIfBufferCfgs.png)


    **这个 buffer 指向一个hth mailbox, 要提前创建一个mailbox, 创建mailbox的配置项如下:**

    ![alt text](./picture/CanHardwareObjects.png)

    **创建 hth 的配置:**

    ![alt text](./picture/CanIfHthCfgs.png)

    总的来说, CanIf 模块中配置的内容不少 相对多一点, 主要是是初始配置中的:CanIfTxPduCfgs,这个配置依赖两个
    地方,一个就是buffer模块以及一个CAN中的一个mailbox模块,主要是这两个部分,因此还需要对CanIfBufferCfgs和
    CanIfInitHohCfgs这两项属性进行配置,并在Can/CanConfigSet/CanHardwareObjects中对MainBox进行新增配置,
    这个地方的配置需要仔细的进行配置和分析








