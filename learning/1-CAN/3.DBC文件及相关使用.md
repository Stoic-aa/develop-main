# DBC 文件制作及相关使用

## 目录

1. [基本概念](#基本概念)

2. [DBC文件制作](#DBC文件制作)

3. [DBC导出CAN-STACK](#DBC导出CAN-STACK)

4. [注意事项](#注意事项)

##  基本概念

1. DBC (database CAN)文件是一种规范性和标准化的一个文件, 核心是包含CAN通信总线中的全部报文及信号属性,通常由OEM或者 tire1 提供, CAN 通信网络就是依靠这个进行协同工作
2. 制作 DBC 文件可以使用 VECTOR CANdb 软件,这个软件是 vector 公司提供的免费的软件

## DBC文件制作
1: 要明确这些内容都是在我们的CAN通信矩阵中有相应的描述. 通过已有的 CAN 通信矩阵制作DCB文件

![制作这样一个dbc文件, 如下面图中标黄的四条信号](.\picture\dbc.png)

**2: 新建 一个 dbc 文件**, file->creat databae,can template 选择 相应的模板:

![alt text](.\picture\creat_database.png)
![alt text](.\picture\creat_database-1.png)

**3: 添加节点**, 看CAN 通信矩阵中的, 节点名称是 VCU,先建立一个节点, 并填好相关的信息:
![alt text](.\picture\addnode_1.png)
![alt text](.\picture\addnode_2.png)

**4: 添加一条 message**, 通过 Excel 通信矩阵可以知道 message 的 ID 是 0xCF, name 是 VCU1, type CAN standard, DLC 为8 , 添加 message:
![alt text](.\picture\addmessage-1.png)
![alt text](.\picture\addmessage-2.png)

message 的发送方式有三种, 可以通过下面的进行先定义后选择:
![alt text](.\picture\msg-mathod-1.png)

先定义 发送方式, 选择方式为: 菜单栏 view-> 
Attribute Defintions
![alt text](.\picture\msg-mathod-2.png)
![alt text](.\picture\msg-mathod-3.png)

给 message 添加属性(attribute), 也就是选择 message 的 发送方式, 并改写 CycleTime, 根据通信矩阵中的描述是 10ms, 改为10 即可
![alt text](.\picture\msg-mathod-4.png)
周期改为10ms
![alt text](.\picture\msg-mathod-5.png)
可以看到 message 属性中也自动同步到了 10 ms
![alt text](.\picture\msg-mathod-6.png)

和上面的同理, 要给我们的 message 发送方法提供一个 attribute 属性, 同样的, 在菜单栏的view-> 
Attribute Defintions中, 新增一个 GenMsgSendType 的属性, 注意属性是选 成了枚举变量 
![alt text](.\picture\msg-mathod-7.png)

添加完毕后, 在message 的属性(attribute)中选择我们的刚才创建的类型

**5: 添加信号**
把 dbc 的模板建立后, 建立 节点和 message, 以及把 message 相关的属性补充完毕后, 就可以为我们的 message 添加相关的信号了, 也就通信的实际 传输的内容, bit 数据流, 信号的创建流程如下:

每条信号的相关属性都在通信矩阵中有相关的详细描述, 可以看上述的通信矩阵的描述信息
基础的信息: name,  length, byte order, value type, unit, factor, offset, min, max
![alt text](.\picture\msg-mathod-8.png)

添加完信号要进行 message 的绑定, 勾选刚才的 VCU1 ,进行message 的绑定;
![alt text](.\picture\msg-mathod-9.png)

接着是创建信号的 **value table**, 和创建 节点的的attribute 一样, 也是菜单栏进行: view -> value table
![alt text](.\picture\msg-mathod-10.png)
![alt text](.\picture\msg-mathod-11.png)

 然后添加相关的详细信息,并在信号中 绑定这个 value table
![alt text](.\picture\msg-mathod-12.png)

把信号建立完毕,并把对应的  value table 绑定到信号中, 同时把信号也绑定我们的 message 类型, 这样我们就可以来到我们的 message 中调整我们的 信号 start bit 内存布局, 如下, 可以手动调节:
![alt text](.\picture\msg-mathod-13.png)

这里根据 通信矩阵调整如下, 调整完毕后就可以进行 进行一致性的检测
![alt text](.\picture\msg-mathod-14.png)

 **6: 检测一致性**
操作是: file-> check consistency
![alt text](.\picture\msg-mathod-15.png)

检测结果是需要添加信号的接收方, 我们先创建一个 node 节点, 作为信号的接收方, 然后在 message 中的 信号处编辑, 在 Receiver 中 add 我们的节点:
![alt text](.\picture\msg-mathod-16.png)
![alt text](.\picture\msg-mathod-17.png)


# DBC导出CAN-STACK

1. 首先在针对S32K144的MCU作为项目的主控, NXP的官网能下载的CBD的相关的代码,然后再进入到 DaVinciConfigurator目录中
![alt text](.\picture\DBC-STACK-1.png)

2. 打开这个exe文件:
![alt text](.\picture\DBC-STACK-2.png)

3. DavinciCFG.exe界面如下所示(需要密钥狗):
![alt text](.\picture\DBC-STACK-3.png)

4. 创建新 project, file->new project, 然后根据自己的选择进行项目的project的配置, 通常一直 next 即可
![alt text](.\picture\CFG_NEW_PROJECT.png)

5. 刚生产的项目是没有其他模块的, 进入到刚才生成的 project 目录下, 然后新建 inputfiles 文件:
![alt text](.\picture\creat_inputfiles_1.png)
![alt text](.\picture\creat_inputfiles_2.png)

6. 然后把 DBC 文件复制到 inputfiles 文件夹下:
![alt text](.\picture\creat_inputfiles_3.png)

7. 继续在 CFG 软件中加载我们刚才复制的 dbc 文件:
![alt text](.\picture\load_dbc_1.png)
![alt text](.\picture\load_dbc_2.png)
![alt text](.\picture\load_dbc_3.png)
![alt text](.\picture\load_dbc_4.png)
![alt text](.\picture\load_dbc_5.png)

8. 加载完,勾选type完毕后,next->finish, 然后就是进行文件的update更新和同步, 这里 DavincinCFG工具会把DBC文件转换为CAN的协议栈相关的模块, 但是由于不同OEM给出的 DBC 文件或有一些不同,因此在同步进行生成CAN-STACK后要进行相关模块报错的修正
![alt text](.\picture\load_dbc_6.png)

9. 同步完毕后, 点击basic,就能看到生成的相关的模块,其中带XX的就代表有问题的模块,解决完这些问题后就能进行代码的生成
![alt text](.\picture\load_dbc_7.png)

10. **通过这里生成的模块可以看到 CAN-STACK 相关的工作流, 例如我们的 COM 模块是接收和封装我们的 CAN signal 信号为 I-PDU, 传送给我们的 CAN-PDuR 模块,进一步传输到CAN-Tp模块等等, 下面可以看出,一些配置信息有相关的descripition描述, 具体更加细节的信息不清楚的话,例如一些值的范围填写,这些内容可以在 Autosar 的官方文档中机进行查看:**
![alt text](.\picture\load_dbc_8.png)


## 注意事项

1. 添加 attribute 的 name 时, 尽量遵循 Vector 的命名规范, 否则的话会出现有些参数同步不到的情况
2. 注意一致性检查时 , 信号的接收方的定义,信号编辑菜单中的 Receiver 是这个信号的接收方的意思, 一般通信矩阵会定义每个信号的接收 节点
3. DBC的文件的相关属性注意:
其中message中的属性的 value 是比较重要的, 达芬奇工具会根据 value 来判断这个 message 是否为特殊的报文, 例如是否属于 nm 网络报文,或者是否属于 diag 诊断报文, 或者是普通 message, 不同的 message 会划分为不同的协议栈类别进行使用
![alt text](.\picture\msg-mathod-18.png)
