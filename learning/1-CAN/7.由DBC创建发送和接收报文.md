# 由DCB创建发送和接收报文

## 目录

1. [简述](##简述)
2. [主要过程](##主要过程)
3. [过程记录](##过程记录)

## 1.简述
基于CAN-STACK,上次我手动进行了一条发送和接收报文的配置,配置过程有些繁琐,且容易出错,正常的在工作中是采用更高效的配置方式进行报文的新增和配置,我们只用解决配置过程中的相关错误和进行报文的校对即可

## 2.主要的过程
这次学习的主要的操作是如何在DBC的文件中新增一条发送和接收的报文,并加载到工程文件中,并通过达芬奇工具生成CAN-STACK中你的报文新增的相关配置代码,完成接收和发送报文的配置W

## 3. 过程记录

1. 打开DCB文件, 之前已经操作DBC的文件,并弄清楚了DBC文件的相关内容,这里直接打开之前的输入DCB文件:

    ![alt text](./picture/open_can_dbc.png)

2. 在 message 中添加新的报文,先加一条发送报文,再加一条接收报文,并编辑 基本信息(name,ID),发送节点选择(tranmitter),message的属性设置(attribute)(周期,周期时间设置),这里还没有进行 signal 的添加, 因为我们的signal还没有配置

    **发送报文**
    ![alt text](./picture/dbc_add_message_1.png)
    ![alt text](./picture/dbc_add_message_2.png)
    ![alt text](./picture/dbc_add_message_3.png)
    **接收报文**
    ![alt text](./picture/dbc_add_message_4.png)
    ![alt text](./picture/dbc_add_message_5.png)
    ![alt text](./picture/dbc_add_message_6.png)

3. 创建发送和接收的 signal ,实际的信号:

    **发送信号**
    ![alt text](./picture/dbc_add_signal_1.png)
    ![alt text](./picture/dbc_add_signal_2.png)
    ![alt text](./picture/dbc_add_signal_3.png)

    **对发送信号的节点进行配置**
    ![alt text](./picture/dbc_add_signal_4.png)
    ![alt text](./picture/dbc_add_signal_5.png)

    **接收信号配置**
    ![alt text](./picture/dbc_add_signal_6.png)
    ![alt text](./picture/dbc_add_signal_7.png)
    ![alt text](./picture/dbc_add_signal_8.png)
    可以调整内布局,再Layout中进行拖拽调节 Left 的信号到最后一个字节(8bit)
    ![alt text](./picture/dbc_add_signal_9.png)

    **对接收节点的配置**
    ![alt text](./picture/dbc_add_signal_15.png)

    **对发送signal进行真值表的建立**
    ![alt text](./picture/dbc_add_signal_10.png)
    ![alt text](./picture/dbc_add_signal_11.png)
    ![alt text](./picture/dbc_add_signal_12.png)
    ![alt text](./picture/dbc_add_signal_13.png)
    ![alt text](./picture/dbc_add_signal_14.png)

4. Davicinc CFG 工具操作过程记录

    4.1 打开 DaVinci CFG 工具,并打开我们的工程文件, 点击 input files 按钮
    ![alt text](./picture/dbc_add_signal_16.png)

    4.2 input Files->open the input files assistant -> 更新DBC文件/新增DBC文件->ECU Instance选择MyECU->next->next->next->next->Update ECU configguration only->start update->fnish

    ![alt text](./picture/dbc_add_signal_17.png)
    ![alt text](./picture/dbc_add_signal_18.png)
    ![alt text](./picture/dbc_add_signal_19.png)
    ![alt text](./picture/dbc_add_signal_21.png)


    4.3 这里生成完毕后, 会有一些错误, 我们需要进行修复,这里就可以利用之前手动配置的报文的相关经验进行错误的修复,先修复PDUR模块

    ![alt text](./picture/dbc_add_signal_22.png)

    先修复PDUR相关报错,这里能看出是由于transmit2没有对应的引用,这里先加上引用:

    ![alt text](./picture/dbc_add_signal_23.png)
    ![alt text](./picture/dbc_add_signal_24.png)

    **Note**
    Transmission Confirmation（Tx Confirmation）是 AUTOSAR COM 模块的核心机制之一，用于通知应用层：某条 CAN/LIN/Ethernet 报文已被底层通信栈（如 CAN Interface、CAN Driver）成功发送到总线上。它是应用层与通信层之间的关键反馈机制，常用于：
    实现发送重试逻辑
    统计报文发送成功率
    释放发送缓冲区 / 资源
    触发后续业务逻辑（如发送下一条关联报文）

    ![alt text](./picture/dbc_add_signal_25.png)

    4.4 修复完PDUR,会发现我们的 CanIf也会被同步的进行修复,但是COM这里的发送模式要进行修复一下:

    ![alt text](./picture/dbc_add_signal_26.png)

5. DataMapping 使用 DaVincin Develop 打开config中你的配置文件:

    ![alt text](./picture/dbc_add_signal_27.png)

    **创建新的 Application Port Interface**

    ![alt text](./picture/dbc_add_signal_28.png)
    ![alt text](./picture/dbc_add_signal_29.png)
    ![alt text](./picture/dbc_add_signal_30.png)

    一共创建三条:

    ![alt text](./picture/dbc_add_signal_31.png)

    **创建完 Application Port Interface 后,进入Application Compoonent Types->CTLed Task中**

    ![alt text](./picture/dbc_add_signal_32.png)
    ![alt text](./picture/dbc_add_signal_33.png)
    ![alt text](./picture/dbc_add_signal_34.png)
    ![alt text](./picture/dbc_add_signal_35.png)
    ![alt text](./picture/dbc_add_signal_36.png)

    再加两个接收的port,一共是创建了三个port

    ![alt text](./picture/dbc_add_signal_37.png)
    ![alt text](./picture/dbc_add_signal_38.png)

    **创建新的 Access**
    
    先建立一个 write access

    ![alt text](./picture/dbc_add_signal_39.png)
    ![alt text](./picture/dbc_add_signal_40.png)

    后建立两个 read access

    ![alt text](./picture/dbc_add_signal_41.png)
    ![alt text](./picture/dbc_add_signal_42.png)



6. 创建完毕,回到我们的 CFG 工具中:

    这里可以看到我们刚才创建的三个 port 已经存在了:

    ![alt text](./picture/dbc_add_signal_43.png)

    三个接口这里同步过来后,我们可以对这些接口进行
    data mapping

    ![alt text](./picture/dbc_add_signal_44.png)
    ![alt text](./picture/dbc_add_signal_45.png)
    ![alt text](./picture/dbc_add_signal_46.png)

7. 映射完毕后,就可以进行代码的生成了

    ![alt text](./picture/dbc_add_signal_47.png)

    这里可以看到相关的变换:

    ![alt text](./picture/dbc_add_signal_48.png)



8. 对生成的代码进行修改

    ![alt text](./picture/dbc_add_signal_49.png)
    ![alt text](./picture/dbc_add_signal_50.png)

    这里是主要的代码改动的地方, 这里需要进行代码修改,修改完毕就可以进行烧录了:

9. 烧录

    编译没问题,烧录有问题的化,可以尝试下面的解决办法

    ![alt text](./picture/dbc_add_signal_51.png)

    成功烧录,测试的话,记得要进行 run 代码的运行才行

    ![alt text](./picture/dbc_add_signal_52.png)


10. 结果分析

    用 TSMaster进行测试,注意添加我们的的DCB文件:

    ![alt text](./picture/dbc_add_signal_53.png)

    发送报文测试:
    1. S32K的发送报文 0X310 上位机能正常的接收
    ![alt text](./picture/dbc_add_signal_54.png)

    接收报文测试:
    1. TSmaster 创建发送报文给S32K
    ![alt text](./picture/dbc_add_signal_55.png)
    ![alt text](./picture/dbc_add_signal_56.png)
    2. 结果S32K能正常的接收我们的报文,进行了上报
    ![alt text](./picture/dbc_add_signal_57.png)
    debug 验证也正确的接收到报文
    ![alt text](./picture/dbc_add_signal_58.png)
    ![alt text](./picture/dbc_add_signal_59.png)
    













